<template>
    <div class="wrap-login">
        <div class="bi">S-ORDER</div>
        <div class="login-btn-area">
            <button class="btn-login naver">네이버 로그인</button>
            <button class="btn-login fb">페이스북 로그인</button>
            <button class="btn-login kakao">카카오톡 로그인</button>
        </div>
<!--
        <div id="naverIdLogin">네이버 로그인</div>
        <div id="facebookLogin" @click="btnFaceBook">페이스북 로그인</div>
        <div id="kakao-login-btn">카카오톡 로그인</div>
        <div id="kakao-logout-btn" @click="btnKakaoLogOut">카카오톡 로그아웃</div>
        <div id="naverIdLogOut" @click="btnNaverLogOut">네이버 로그아웃</div>
        <div id="facebookLogout" @click="btnFaceBookLogOut">페이스북 로그아웃</div>-->
    </div>
</template>

<script>
    import facebookLib from '@/commons/lib/facebookLoginLib';
    import commonSv from '@/commons/sv/commonSv';
    import serverSv from '@/commons/sv/serverSv';
    import configSv from '@/commons/sv/configSv';

    export default {

        mounted() {
            var this_ = this;

            //카카오톡 로그인
            Kakao.Auth.createLoginButton({
                container: '#kakao-login-btn',
                success: function (authObj) {
                    // 로그인 성공시, API를 호출합니다.
                    Kakao.API.request({
                        url: '/v2/user/me',
                        success: function (res) {
                            this_.loginType = 'KAKAO';
                            this_.socialID = res.id;
                            this_.nickName = res.properties.nickname;
                            this_.email = res.properties.email;
                            this_.loginCheck();
                        },
                        fail: function (error) {
                            console.log("error == ", error);
                        }
                    });
                },
                fail: function (err) {
                    console.log("err == ", err);
                }
            });
            //카카오톡 로그인

            //네이버 로그인
            this.naverLogin = new naver.LoginWithNaverId(
                {
                    clientId: configSv.naverClientID[process.env.nodeEnv],
                    callbackUrl: "http://" + window.location.hostname + ((location.port == "" || location.port == undefined) ? "" : ":" + location.port) + "/c/" + this.storeNo + "/member/naverPopup",
                    isPopup: true,
                    loginButton: {color: "green", type: 3, height: 60} /* 로그인 버튼의 타입을 지정 */
                }
            );
            this.naverLogin.init();

            if (this.$route.query.loginType == 'NAVER') {
                var this_ = this;
                this.naverLogin.getLoginStatus(function (status) {
                    console.log("this_.naverLogin == ", this_.naverLogin);
                    if (status) {
                        this_.loginType = 'NAVER';
                        this_.socialID = this_.naverLogin.user.id;
                        this_.email = this_.naverLogin.user.email;
                        this_.nickname = this_.naverLogin.user.nickname;
                        this_.loginCheck();
                    } else {
                        commonSv.goUrlToName(this, 'id-main');
                    }
                });
            }
            //네이버 로그인

            //페이스북 로그인
            facebookLib.loadFaceBookSdk(176443019965077, 'v3.2')
                .then(facebookLib.getFaceBookLoginStatus);
            //페이스북 로그인
        },

        created() {
            localStorage.setItem("token","");
            localStorage.removeItem('customerNo')
        },

        data() {
            return {
                /**
                 * 상점 번호
                 * @type {string}
                 */
                storeNo: this.$router.currentRoute.path.split('/')[1],
                loginType: '',
                socialID: '',
                nickName: '',
                email:'',
                naverLogin: undefined,
                loginOptions: {
                    type: Object,
                    default: function () {
                        return {
                            scope: 'email'
                        }
                    }
                }
            }
        },

        methods: {
            btnFaceBook() {//페이스북 로그인 요청
                facebookLib.faceBookLogin(this.loginOptions)
                    .then(response => {
                        if (response.status === 'connected') {
                            facebookLib.faceBookGetUserData()
                                .then(res => {
                                    console.log("res == ", res);
                                    this.loginType = 'FACEBOOK';
                                    this.socialID = res.id;
                                    this.email = res.email;
                                    this.nickname = res.nickname;
                                    this.loginCheck();
                                })
                        } else {
                            console.log("facebook fbLogin == ", response);
                        }
                    })
            },
            btnFaceBookLogOut() {//페이스북 로그 아웃
                facebookLib.faceBookLogout()
                    .then(response => {
                        console.log("facebook faceBookLogout == ", response);
                    })
            },
            btnKakaoLogOut() {//카카오톡 로그아웃
                Kakao.Auth.logout(function (obj) {
                    console.log("Kakao logout == ", obj)
                })
            },
            btnNaverLogOut() {//네이버 로그아웃
                console.log("naverLogin logout == ")
                this.naverLogin.logout();
            },
            loginCheck() {
                if (this.loginType && this.socialID) {
                    serverSv.post('/api/member/customerMemberSocialLogin', {'customerMember': {'loginType': this.loginType, 'socialID': this.socialID, 'email': this.email, 'nickName': this.nickName}, 'storeNo': this.storeNo}).then(res => {
                        if (res.data.data.check) {
                            localStorage.setItem('token', res.data.data.token);
                            localStorage.setItem('customerNo', res.data.data.customerNo);
                            this.$nuxt.$emit('customerLoginCheck', {});
                            commonSv.goUrlToName(this, 'id-main');
                        } else {
                            commonSv.goUrlToName(this, 'id-member-authPage', {'loginType': this.loginType});
                        }
                    }).catch(e => {
                        console.log('e===', e);
                        commonSv.alert(this, '알림', e.data.message);
                    });
                } else {
                    commonSv.alert(this, '알림', '소셜 로그인을 다시 요청해 주세요.');
                }
            },
        }
    }

</script>
